<!DOCTYPE html>
<html>
<head>
<!-- Front-end: edit styles in liff/css/checkin.css -->
<link rel="stylesheet" href="css/checkin.css">
<meta charset="UTF-8">
<title>Check-in</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <!--อย่าพึ่งทำหน้านี้ มันต้องรัน ngrok อธิบายยาก555-->


  <!--
  วิธีเข้าหน้านี้
  1.ใช้อาจารย์สร้าง qr 
    1.1 ถ้าไม่มีรหัสอาจารย์ ใช้ email:testtest@gmail.com pass:123456789 ไปก่อน
  2.สร้าง qr เสร็จ อย่าพึ่งออกจากหน้า จะมีลิงค์เด้งขึ้นมา ก็อปลิงค์นั้นแล้วไปวางหน้าใหม่
  3.ถ้าเข้าครั้งแรก ให้ login LINE แล้วใส่ข้อมูล เสร็จแล้วออกเข้าใหม่ login LINE จะเข้ามาหน้านี้
  -->


  <!-------------------------------------------->
<h2>เช็คชื่อเข้าเรียน</h2><!--พวกกล่องแสดงอยู่ตรงนี้-->
<button onclick="checkin()">เช็คชื่อ</button>
  <!-------------------------------------------->

<script>
    const token = new URLSearchParams(location.search).get("token");
async function checkin() {

  await liff.init({ liffId: "2008718294-WzVz06TP" });
  await liff.ready;
  

  const token = new URLSearchParams(location.search).get("token");
   if (!token) {
     alert("QR ไม่ถูกต้อง");
     return;
   }

  if (!navigator.geolocation) {
    alert("อุปกรณ์นี้ไม่รองรับ GPS");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {

      const profile = await liff.getProfile();

      const res = await fetch("../api/checkin.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: token,
          line_user_id: profile.userId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy
        })
      });
      const text = await res.text();

if (!text) {
  alert("Server ไม่ส่งข้อมูลกลับ");
  return;
}

let data;
try {
  data = JSON.parse(text);
} catch {
  alert("Response ไม่ใช่ JSON:\n" + text);
  return;
}

alert(data.message);

    },
    () => alert("กรุณาอนุญาตแชร์ตำแหน่ง"),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}
</script>

</body>
</html>
