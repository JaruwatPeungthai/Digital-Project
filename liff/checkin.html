<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 500px;
    width: 100%;
    overflow: hidden;
  }

  .header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 20px;
    text-align: center;
  }

  .header h1 {
    font-size: 24px;
    margin-bottom: 5px;
  }

  .header p {
    font-size: 12px;
    opacity: 0.9;
  }

  .content {
    padding: 30px 20px;
  }

  .loading {
    text-align: center;
    padding: 40px 20px;
    display: none;
  }

  .spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .info-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-label {
    font-weight: 600;
    color: #667eea;
    font-size: 13px;
    text-transform: uppercase;
  }

  .info-value {
    color: #333;
    font-size: 14px;
    font-weight: 500;
    text-align: right;
    flex: 1;
    padding-left: 15px;
  }

  .action-section {
    margin-top: 30px;
  }

  .button-group {
    display: flex;
    gap: 12px;
    margin-top: 15px;
  }

  button {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn-checkin {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    color: white;
  }

  .btn-checkin:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
  }

  .btn-checkin:active:not(:disabled) {
    transform: translateY(0);
  }

  .btn-checkin:disabled {
    background: linear-gradient(135deg, #ccc 0%, #999 100%);
    cursor: not-allowed;
    opacity: 0.6;
  }

  .btn-checkout {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
  }

  .btn-checkout:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(33, 150, 243, 0.3);
  }

  .btn-checkout:active:not(:disabled) {
    transform: translateY(0);
  }

  .btn-checkout:disabled {
    background: linear-gradient(135deg, #ccc 0%, #999 100%);
    cursor: not-allowed;
    opacity: 0.6;
  }

  .status-message {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 13px;
    display: none;
  }

  .status-success {
    background: #e8f5e9;
    border-left: 4px solid #4caf50;
    color: #2e7d32;
  }

  .status-warning {
    background: #fff3e0;
    border-left: 4px solid #ff9800;
    color: #e65100;
  }

  .status-info {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    color: #1565c0;
  }

  .countdown {
    text-align: center;
    background: #fff3e0;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    font-weight: 600;
    color: #e65100;
    display: none;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-top: 5px;
  }

  .badge-checkin {
    background: #c8e6c9;
    color: #2e7d32;
  }

  .badge-late {
    background: #ffcdd2;
    color: #c62828;
  }

  .badge-checkout {
    background: #bbdefb;
    color: #1565c0;
  }

  .badge-not-checkout {
    background: #ffccbc;
    color: #d84315;
  }

  .error-message {
    color: #d32f2f;
    text-align: center;
    padding: 20px;
    background: #ffebee;
    border-radius: 8px;
    display: none;
  }

  /* Modal Popup Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal-popup {
    background: white;
    border-radius: 15px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 90%;
    padding: 30px 20px;
    text-align: center;
    animation: slideUp 0.3s ease-out;
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-popup.success {
    border-left: 5px solid #4caf50;
  }

  .modal-popup.error {
    border-left: 5px solid #d32f2f;
  }

  .modal-popup.warning {
    border-left: 5px solid #ff9800;
  }

  .modal-popup.info {
    border-left: 5px solid #2196f3;
  }

  .modal-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
  }

  .modal-message {
    font-size: 15px;
    color: #666;
    margin-bottom: 25px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .modal-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 100px;
  }

  .modal-btn-ok {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    color: white;
  }

  .modal-btn-ok:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
  }

  .modal-btn-cancel {
    background: #f0f0f0;
    color: #333;
  }

  .modal-btn-cancel:hover {
    background: #e0e0e0;
    transform: translateY(-2px);
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìã ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å</h1>
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö GPS ‡∏î‡πâ‡∏ß‡∏¢ LINE</p>
  </div>

  <div class="content">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 15px; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div id="errorContainer" class="error-message"></div>

    <div id="mainContent" style="display: none;">
      <!-- Student & Session Info -->
      <div class="info-section">
        <div class="info-row">
          <span class="info-label">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span>
          <span class="info-value" id="subjectName">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Session</span>
          <span class="info-value" id="roomName">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
          <span class="info-value" id="studentCode">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</span>
          <span class="info-value" id="fullName">-</span>
        </div>
      </div>

      <!-- Check-in Status -->
      <div id="checkinStatusMsg" class="status-message status-success"></div>

      <!-- Check-out Status -->
      <div id="checkoutStatusMsg" class="status-message status-success"></div>

      <!-- Warning Status -->
      <div id="warningMsg" class="status-message status-warning"></div>

      <!-- Countdown for checkout -->
      <div id="countdownMsg" class="countdown"></div>

      <!-- Action Buttons -->
      <div class="action-section">
        <div class="button-group">
          <button id="btnCheckin" class="btn-checkin" onclick="performCheckin()">
            üìå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤
          </button>
        </div>

        <div class="button-group">
          <button id="btnCheckout" class="btn-checkout" onclick="performCheckout()" disabled>
            üì§ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å
          </button>
        </div>

        <div class="button-group">
          <a href="student_dashboard.html" style="flex: 1; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 15px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 20px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            üë®‚Äçüéì Dashboard
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Popup -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal-popup" id="modalPopup">
    <div class="modal-title" id="modalTitle">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
    <div class="modal-message" id="modalMessage"></div>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-ok" id="modalOkBtn" onclick="closeModal()">‡∏ï‡∏Å‡∏•‡∏á</button>
      <button class="modal-btn modal-btn-cancel" id="modalCancelBtn" onclick="closeModal()" style="display: none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<script>
  const token = new URLSearchParams(location.search).get("token");
  let liffProfile = null;
  let sessionDetails = {};
  let currentStatus = {};

  // Modal Popup Functions
  function showModal(message, type = 'info', title = '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', hasCancel = false) {
    const overlay = document.getElementById('modalOverlay');
    const popup = document.getElementById('modalPopup');
    const titleEl = document.getElementById('modalTitle');
    const messageEl = document.getElementById('modalMessage');
    const okBtn = document.getElementById('modalOkBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');

    titleEl.textContent = title;
    messageEl.textContent = message;
    
    // Set popup style based on type
    popup.className = `modal-popup ${type}`;
    
    // Show/hide cancel button
    cancelBtn.style.display = hasCancel ? 'block' : 'none';
    
    overlay.classList.add('active');
  }

  function closeModal() {
    const overlay = document.getElementById('modalOverlay');
    overlay.classList.remove('active');
  }

  async function initLiff() {
    try {
      await liff.init({ liffId: "2008718294-WzVz06TP" });
      await liff.ready;

      if (liff.isLoggedIn()) {
        liffProfile = await liff.getProfile();
        await loadSessionDetails();
        await checkStatus();
        // Check status every 5 seconds
        setInterval(checkStatus, 5000);
      } else {
        showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login LINE ‡∏Å‡πà‡∏≠‡∏ô");
        liff.login();
      }
    } catch (err) {
      showError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
    }
  }

  async function loadSessionDetails() {
    if (!token || !liffProfile) return;

    try {
      const res = await fetch("../api/get_session_details.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: token,
          line_user_id: liffProfile.userId
        })
      });

      const data = await res.json();
      if (data.error) {
        showError(data.error);
        return;
      }

      sessionDetails = data;
      updateSessionInfo();
      document.getElementById("loading").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
    } catch (err) {
      showError("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message);
    }
  }

  function updateSessionInfo() {
    document.getElementById("studentCode").textContent = sessionDetails.student_code || "-";
    document.getElementById("fullName").textContent = sessionDetails.full_name || "-";
    document.getElementById("subjectName").textContent = sessionDetails.subject_name || "-";
    document.getElementById("roomName").textContent = sessionDetails.room_name || "-";
  }

  async function checkStatus() {
    if (!token || !liffProfile) return;

    try {
      const res = await fetch("../api/check_status.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: token,
          line_user_id: liffProfile.userId
        })
      });

      const data = await res.json();
      currentStatus = data;
      updateStatusUI();
    } catch (err) {
      console.error("Status check error:", err);
    }
  }

  function updateStatusUI() {
    const btnCheckin = document.getElementById("btnCheckin");
    const btnCheckout = document.getElementById("btnCheckout");
    const checkinMsg = document.getElementById("checkinStatusMsg");
    const checkoutMsg = document.getElementById("checkoutStatusMsg");
    const warningMsg = document.getElementById("warningMsg");
    const countdownMsg = document.getElementById("countdownMsg");

    // Reset
    checkinMsg.style.display = "none";
    checkoutMsg.style.display = "none";
    warningMsg.style.display = "none";
    countdownMsg.style.display = "none";

    if (currentStatus.has_checked_in) {
      // Show check-in status
      let badge = currentStatus.checkin_status === "late" 
        ? '<span class="status-badge badge-late">‚è±Ô∏è ‡∏™‡∏≤‡∏¢</span>'
        : '<span class="status-badge badge-checkin">‚úÖ ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
      checkinMsg.innerHTML = `‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ß‡∏•‡∏≤ ${currentStatus.checkin_time}${badge}`;
      checkinMsg.style.display = "block";

      // Disable check-in button
      btnCheckin.disabled = true;

      if (currentStatus.has_checked_out) {
        // Show check-out status
        checkoutMsg.innerHTML = `‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ß‡∏•‡∏≤ ${currentStatus.checkout_time}`;
        checkoutMsg.style.display = "block";
        btnCheckout.disabled = true;
      } else {
        // Not checked out yet
        if (currentStatus.can_checkout) {
          // Enable checkout button
          btnCheckout.disabled = false;
        } else {
          // Show countdown and disable button
          warningMsg.innerHTML = "‚è≥ ‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å...";
          warningMsg.style.display = "block";
          updateCountdown();
          btnCheckout.disabled = true;
        }
      }
    } else {
      // Not checked in
      warningMsg.innerHTML = "‚è≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡πà‡∏≠‡∏ô";
      warningMsg.style.display = "block";
      btnCheckin.disabled = false;
      btnCheckout.disabled = true;
    }
  }

  function updateCountdown() {
    if (!sessionDetails.checkout_start) return;

    const now = new Date();
    const checkoutStartTime = new Date(sessionDetails.checkout_start);
    const timeDiff = checkoutStartTime - now;

    if (timeDiff <= 0) {
      document.getElementById("countdownMsg").style.display = "none";
      checkStatus(); // Recheck to enable button
    } else {
      const minutes = Math.floor(timeDiff / 60000);
      const seconds = Math.floor((timeDiff % 60000) / 1000);
      const countdownMsg = document.getElementById("countdownMsg");
      countdownMsg.textContent = `‚è∞ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÉ‡∏ô ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ ${seconds} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
      countdownMsg.style.display = "block";
    }
  }

  async function performCheckin() {
    const btn = document.getElementById("btnCheckin");
    btn.disabled = true;
    btn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠...";

    try {
      if (!navigator.geolocation) {
        showModal("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS", "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        btn.disabled = false;
        btn.textContent = "üìå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          try {
            const res = await fetch("../api/checkin.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token: token,
                line_user_id: liffProfile.userId,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy
              })
            });

            const text = await res.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch {
              showModal("Response ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON:\n" + text, "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
              btn.disabled = false;
              btn.textContent = "üìå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤";
              return;
            }

            showModal(data.message, "success", "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            await checkStatus();
            btn.textContent = "üìå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤";
          } catch (err) {
            showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            btn.disabled = false;
            btn.textContent = "üìå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤";
          }
        },
        () => {
          showModal("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", "warning", "‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô");
          btn.disabled = false;
          btn.textContent = "üìå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    } catch (err) {
      showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      btn.disabled = false;
      btn.textContent = "üìå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤";
    }
  }

  async function performCheckout() {
    const btn = document.getElementById("btnCheckout");
    btn.disabled = true;
    btn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å...";

    try {
      if (!navigator.geolocation) {
        showModal("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS", "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        btn.disabled = false;
        btn.textContent = "üì§ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          try {
            const res = await fetch("../api/checkout.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token: token,
                line_user_id: liffProfile.userId,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy
              })
            });

            const text = await res.text();
            let data;
            try {
              data = JSON.parse(text);
            } catch {
              showModal("Response ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON:\n" + text, "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
              btn.disabled = false;
              btn.textContent = "üì§ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
              return;
            }

            showModal(data.message, "success", "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            await checkStatus();
            btn.textContent = "üì§ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
          } catch (err) {
            showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            btn.disabled = false;
            btn.textContent = "üì§ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
          }
        },
        () => {
          showModal("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏ä‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", "warning", "‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô");
          btn.disabled = false;
          btn.textContent = "üì§ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    } catch (err) {
      showModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message, "error", "‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      btn.disabled = false;
      btn.textContent = "üì§ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å";
    }
  }

  function showError(message) {
    document.getElementById("loading").style.display = "none";
    const errorContainer = document.getElementById("errorContainer");
    errorContainer.textContent = "‚ùå " + message;
    errorContainer.style.display = "block";
  }

  // Initialize
  initLiff();

  // Update countdown every second
  setInterval(updateCountdown, 1000);
</script>

</body>
</html>
