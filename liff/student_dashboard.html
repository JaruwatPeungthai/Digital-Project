<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Student Dashboard</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background-color: #f2f2f2; }
.profile-section { background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
.profile-row { margin: 10px 0; }
.profile-row label { font-weight: bold; display: inline-block; width: 150px; }
input, select { padding: 5px; margin-right: 10px; }
button { padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
button:hover { background-color: #0056b3; }
.advisor-info { background-color: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
.modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; }
.close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.close:hover { color: black; }
.request-status { padding: 10px; border-radius: 4px; margin: 10px 0; }
.pending { background-color: #fff3cd; color: #856404; }
.approved { background-color: #d4edda; color: #155724; }
.rejected { background-color: #f8d7da; color: #721c24; }
</style>
</head>
<body>

<h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>

<div class="profile-section">
  <div class="profile-row">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</label>
    <input type="text" id="code" readonly>
    <span id="codeDisplay"></span>
  </div>
  
  <div class="profile-row">
    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
    <input type="text" id="name">
  </div>

  <div class="profile-row">
    <label>‡∏™‡∏≤‡∏Ç‡∏≤:</label>
    <select id="major">
      <option value="‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
      <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô</option>
      <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏û">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏û</option>
      <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°</option>
      <option value="‡∏ô‡∏¥‡πÄ‡∏ó‡∏®">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®</option>
    </select>
  </div>

  <div class="profile-row">
    <label>‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:</label>
    <span id="advisorInfo" style="color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</span>
  </div>

  <div class="profile-row">
    <button onclick="toggleEdit()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button onclick="openRequestsModal()" style="background-color: #28a745;">üìã ‡∏î‡∏π‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  </div>

  <div id="editStatus"></div>
</div>

<hr>

<h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>

<table>
<thead>
<tr>
  <th>‡∏ß‡∏¥‡∏ä‡∏≤</th>
  <th>‡∏´‡πâ‡∏≠‡∏á</th>
  <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
</tr>
</thead>
<tbody id="logs"></tbody>
</table>

<!-- Modal for viewing requests -->
<div id="requestsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeRequestsModal()">&times;</span>
    <h2>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
    <input type="text" id="searchRequestId" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Request ID" onkeyup="searchRequests()">
    <div id="requestsList"></div>
  </div>
</div>

<script>
const LIFF_ID = "2008718294-WzVz06TP";
let lineUserId = "";
let studentData = {};
let editMode = false;

async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  lineUserId = profile.userId;

  loadProfile();
  loadHistory();
}

async function loadProfile() {
  const res = await fetch("../api/student_profile.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ line_user_id: lineUserId })
  });

  const data = await res.json();
  studentData = data;

  document.getElementById("codeDisplay").innerText = data.student_code;
  document.getElementById("code").value = data.student_code;
  document.getElementById("name").value = data.full_name;
  document.getElementById("major").value = data.class_group;

  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤
  if (data.advisor_name) {
    document.getElementById("advisorInfo").innerHTML = 
      '<span class="advisor-info">üë®‚Äçüè´ ' + data.advisor_name + '</span>';
  }
}

async function loadHistory() {
  const res = await fetch("../api/attendance_history.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ line_user_id: lineUserId })
  });

  const rows = await res.json();
  const tbody = document.getElementById("logs");
  tbody.innerHTML = "";

  if (rows.length === 0) {
    tbody.innerHTML = "<tr><td colspan='4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>";
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.subject_name}</td>
      <td>${r.room_name}</td>
      <td>${r.checkin_time}</td>
      <td>${r.status === "present" ? "‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß" : "‚ùå ‡∏Ç‡∏≤‡∏î"}</td>
    `;
    tbody.appendChild(tr);
  });
}

function toggleEdit() {
  editMode = !editMode;
  document.getElementById("code").readOnly = !editMode;
  document.getElementById("name").readOnly = !editMode;
  document.getElementById("major").disabled = !editMode;
  
  if (!editMode) {
    // Reset values
    document.getElementById("code").value = studentData.student_code;
    document.getElementById("name").value = studentData.full_name;
    document.getElementById("major").value = studentData.class_group;
    document.getElementById("editStatus").innerHTML = "";
  }
}

async function updateName() {
  const newCode = document.getElementById("code").value;
  const newName = document.getElementById("name").value;
  const newClass = document.getElementById("major").value;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  if (newCode === studentData.student_code && 
      newName === studentData.full_name && 
      newClass === studentData.class_group) {
    document.getElementById("editStatus").innerHTML = 
      '<div class="request-status">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    return;
  }

  const res = await fetch("../api/student_edit_request.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      line_user_id: lineUserId,
      student_code: newCode,
      full_name: newName,
      class_group: newClass
    })
  });

  const data = await res.json();
  
  if (data.status === "success") {
    document.getElementById("editStatus").innerHTML = 
      '<div class="request-status pending">‚úì ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß (Request ID: ' + data.request_id + ')</div>';
    editMode = false;
    toggleEdit();
  } else {
    document.getElementById("editStatus").innerHTML = 
      '<div class="request-status rejected">‚úó ' + data.message + '</div>';
  }
}

function openRequestsModal() {
  document.getElementById("requestsModal").style.display = "block";
  loadRequests("");
}

function closeRequestsModal() {
  document.getElementById("requestsModal").style.display = "none";
}

async function loadRequests(searchId) {
  const res = await fetch("../api/get_student_requests.php?line_user_id=" + lineUserId + 
    (searchId ? "&search=" + searchId : ""), {
    method: "GET",
    headers: { "Content-Type": "application/json" }
  });

  const requests = await res.json();
  const list = document.getElementById("requestsList");
  
  if (requests.length === 0) {
    list.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>";
    return;
  }

  let html = "";
  requests.forEach(req => {
    const statusClass = req.status === "pending" ? "pending" : 
                       (req.status === "approved" ? "approved" : "rejected");
    const statusText = req.status === "pending" ? "‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" : 
                      (req.status === "approved" ? "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò");

    html += `
      <div class="request-status ${statusClass}">
        <strong>Request ID: ${req.request_id}</strong><br>
        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${req.created_at}<br>
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusText}<br>
        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤:</strong> ${req.old_student_code} / ${req.old_full_name} / ${req.old_class_group}<br>
        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà:</strong> ${req.new_student_code} / ${req.new_full_name} / ${req.new_class_group}
      </div>
    `;
  });

  list.innerHTML = html;
}

function searchRequests() {
  const searchId = document.getElementById("searchRequestId").value;
  loadRequests(searchId);
}

window.onclick = function(event) {
  const modal = document.getElementById("requestsModal");
  if (event.target === modal) {
    modal.style.display = "none";
  }
}

init();
</script>

</body>
</html>

