<!DOCTYPE html>
<html>
<head>

</style>
</head>
<body>


<meta charset="UTF-8">
<title>Student Dashboard</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Front-end: edit styles in liff/css/student_dashboard.css -->
<link rel="stylesheet" href="css/sidebar.css">
<link rel="stylesheet" href="css/student_dashboard.css">

<style>
.sidebar-header h2 { font-size: 14px; }

.profile-section { background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
.profile-row { margin: 10px 0; }
.profile-row label { font-weight: bold; display: inline-block; min-width: 150px; }
input, select { padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif; }
.advisor-info { background-color: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
.close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.close:hover { color: black; }
.request-status { padding: 10px; border-radius: 4px; margin: 10px 0; }
.pending { background-color: #fff3cd; color: #856404; }
.approved { background-color: #d4edda; color: #155724; }
.rejected { background-color: #f8d7da; color: #721c24; }

/* Table styles from session_attendance.css */
.table-wrapper {
  overflow-x: auto;
}

.attendance-table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
}

.attendance-table th {
  background: #f2f2f2;
  border: 1px solid #e6eef6;
  padding: 10px;
  font-weight: 600;
  white-space: nowrap;
}

.attendance-table td {
  border: 1px solid #e6eef6;
  padding: 10px;
  vertical-align: middle;
}

.attendance-table .table-row:hover {
  background: #f9fbfd;
}

.status-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: bold;
}

.badge-late {
  background-color: #ffcdd2;
  color: #c62828;
}

.badge-on-time {
  background-color: #c8e6c9;
  color: #2e7d32;
}

.badge-checked-out {
  background-color: #bbdefb;
  color: #1565c0;
}

.badge-not-checked-out {
  background-color: #ffccbc;
  color: #d84315;
}
</style>
</head>
<body>

<!-- Student Sidebar -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h2 id="sidebarTitle">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
  </div>
  
  <nav class="sidebar-menu">
    <ul class="menu-list">
      <li class="menu-item active">
        <a href="#profile" class="menu-link" onclick="showProfile(event)">
          üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
        </a>
      </li>
      <li class="menu-item">
        <a href="#attendance" class="menu-link" onclick="showAttendance(event)">
          üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </a>
      </li>
      <li class="menu-item">
        <a href="#requests" class="menu-link" onclick="showRequests(event)">
          üìù ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </a>
      </li>
    </ul>
  </nav>
</aside>

<!-- Main Content -->
<div class="main-wrapper">
  <div class="header">
    <h2 id="page-title">üë®‚Äçüéì Dashboard ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
  </div>

  <div class="content-area">
    <div class="container">

      <!-- Profile Section (Default View) -->
      <div id="profileContent" class="card profile-section">
        <h3 class="section-header">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        
  <div class="profile-row">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</label>
    <span id="codeDisplay" style="font-weight: bold;"></span>
  </div>
  
  <div class="profile-row">
    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
    <span id="nameDisplay" style="font-weight: bold;"></span>
  </div>

  <div class="profile-row">
    <label>‡∏™‡∏≤‡∏Ç‡∏≤:</label>
    <span id="majorDisplay" style="font-weight: bold;"></span>
  </div>

  <div class="profile-row">
    <label>‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:</label>
    <span id="advisorInfo" style="color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</span>
  </div>

        <div class="profile-row" style="margin-top: 20px;">
          <button onclick="openEditModal()" class="btn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <div id="editStatus"></div>
      </div>

      <!-- Attendance History Section -->
      <div id="attendanceContent" class="card" style="display: none;">
        <h3 class="section-header">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        
        <div class="table-wrapper">
          <table class="attendance-table">
            <thead>
              <tr class="table-header">
                <th>‡∏ß‡∏¥‡∏ä‡∏≤</th>
                <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î session</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà session</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏Å</th>
              </tr>
            </thead>
            <tbody id="logs">
              <tr><td colspan="7">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Requests Section -->
      <div id="requestsContent" class="card" style="display: none;">
        <h3 class="section-header">üìù ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        
        <div style="margin-bottom: 15px;">
          <input 
            type="text" 
            id="searchRequestId" 
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Request ID" 
            onkeyup="searchRequests()"
            style="width: 100%; max-width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
          >
        </div>

        <div id="requestsList">
          <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal for editing profile -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
    
    <div class="profile-row">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</label>
      <input type="text" id="editCode">
    </div>
    
    <div class="profile-row">
      <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
      <input type="text" id="editName">
    </div>

    <div class="profile-row">
      <label>‡∏™‡∏≤‡∏Ç‡∏≤:</label>
      <select id="editMajor">
        <option value="‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
        <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô</option>
        <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏û">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏û</option>
        <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°</option>
        <option value="‡∏ô‡∏¥‡πÄ‡∏ó‡∏®">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®</option>
      </select>
    </div>

    <div id="editModalStatus"></div>

    <div class="profile-row" style="margin-top: 20px;">
      <button onclick="submitEditRequest()" class="btn btn-primary" style="margin-right: 8px;">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button onclick="closeEditModal()" class="btn" style="background: #6c757d;">‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2008718294-WzVz06TP";
let lineUserId = "";
let studentData = {};

// Sidebar menu management
function showProfile(e) {
  if (e) e.preventDefault();
  setActiveMenu(0);
  document.getElementById("profileContent").style.display = "block";
  document.getElementById("attendanceContent").style.display = "none";
  document.getElementById("requestsContent").style.display = "none";
  document.getElementById("page-title").innerText = "üë®‚Äçüéì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô";
}

function showAttendance(e) {
  if (e) e.preventDefault();
  setActiveMenu(1);
  document.getElementById("profileContent").style.display = "none";
  document.getElementById("attendanceContent").style.display = "block";
  document.getElementById("requestsContent").style.display = "none";
  document.getElementById("page-title").innerText = "üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
  loadHistory();
}

function showRequests(e) {
  if (e) e.preventDefault();
  setActiveMenu(2);
  document.getElementById("profileContent").style.display = "none";
  document.getElementById("attendanceContent").style.display = "none";
  document.getElementById("requestsContent").style.display = "block";
  document.getElementById("page-title").innerText = "üìù ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  loadRequests("");
}

function setActiveMenu(index) {
  const items = document.querySelectorAll(".sidebar-menu .menu-item");
  items.forEach((item, i) => {
    item.classList.toggle("active", i === index);
  });
}

async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  lineUserId = profile.userId;

  loadProfile();
}

async function loadProfile() {
  try {
    const res = await fetch("../api/student_profile.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ line_user_id: lineUserId })
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("codeDisplay").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from student_profile.php");
      document.getElementById("codeDisplay").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      return;
    }

    const data = JSON.parse(text);
    
    if (data.error) {
      console.error("API error:", data.error);
      document.getElementById("codeDisplay").innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + data.error;
      return;
    }

    studentData = data;

    document.getElementById("codeDisplay").innerText = data.student_code;
    document.getElementById("nameDisplay").innerText = data.full_name;
    document.getElementById("majorDisplay").innerText = data.class_group;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤
    if (data.advisor_name) {
      document.getElementById("advisorInfo").innerHTML = 
        '<span class="advisor-info">üë®‚Äçüè´ ' + data.advisor_name + '</span>';
    }
    // Set sidebar title to the logged-in student's name
    var st = document.getElementById('sidebarTitle');
    if (st) st.innerText = 'üë®‚Äçüéì ' + (data.full_name || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
  } catch (error) {
    console.error("loadProfile error:", error);
    document.getElementById("codeDisplay").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
  }
}

async function loadHistory() {
  try {
    const res = await fetch("../api/attendance_history.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ line_user_id: lineUserId })
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("logs").innerHTML = "<tr><td colspan='7'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</td></tr>";
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from attendance_history.php");
      document.getElementById("logs").innerHTML = "<tr><td colspan='7'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>";
      return;
    }

    const rows = JSON.parse(text);
    const tbody = document.getElementById("logs");
    tbody.innerHTML = "";

    if (!Array.isArray(rows) || rows.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>";
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.className = "table-row";
      
      // Helper function to format time (HH:mm only, no date)
      const formatTime = (datetime) => {
        if (!datetime) return null;
        const date = new Date(datetime);
        return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
      };
      
      // Helper function to format session date
      const formatSessionDate = (datetime) => {
        if (!datetime) return '';
        const date = new Date(datetime);
        const dayInThai = { 'Sun': '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', 'Mon': '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', 'Tue': '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', 'Wed': '‡∏û‡∏∏‡∏ò', 'Thu': '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', 'Fri': '‡∏®‡∏∏‡∏Å‡∏£‡πå', 'Sat': '‡πÄ‡∏™‡∏≤‡∏£‡πå' };
        const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Bangkok' };
        const parts = date.toLocaleDateString('th-TH', options).split('/');
        const dayName = new Date(datetime).toLocaleDateString('en-US', { weekday: 'short' });
        const thaiDay = dayInThai[dayName] || dayName;
        return `${parts[0]}/${parts[1]}/${parts[2]} (${thaiDay})`;
      };
      
      // Helper function to create status badge HTML for check-in
      const getCheckinStatusBadge = (checkinTime, checkinStatus) => {
        if (!checkinStatus) {
          return '<span class="status-badge badge-not-checked-out">-</span>';
        }
        const badgeClass = checkinStatus === 'late' ? 'badge-late' : 'badge-on-time';
        const statusText = checkinStatus === 'late' ? '‚è±Ô∏è ‡∏™‡∏≤‡∏¢' : '‚úÖ ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
        return `<span class="status-badge ${badgeClass}">${statusText}</span>`;
      };
      
      const getCheckoutStatusBadge = (checkinTime, checkoutStatus) => {
        if (!checkoutStatus) {
          return '<span class="status-badge badge-not-checked-out">-</span>';
        }
        const badgeClass = checkoutStatus === 'checked-out' ? 'badge-checked-out' : 'badge-not-checked-out';
        const statusText = checkoutStatus === 'checked-out' ? '‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å' : '‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å';
        return `<span class="status-badge ${badgeClass}">${statusText}</span>`;
      };
      
      const checkinTimeFormatted = formatTime(r.checkin_time);
      const checkoutTimeFormatted = formatTime(r.checkout_time);
      const sessionDateFormatted = formatSessionDate(r.session_date);
      
      tr.innerHTML = `
        <td>${r.subject_name}</td>
        <td>${r.room_name}</td>
        <td>${sessionDateFormatted}</td>
        <td>${r.checkin_time ? checkinTimeFormatted : (r.checkin_status ? '(‡πÄ‡∏ä‡πá‡∏Ñ Manual)' : '-')}</td>
        <td>${getCheckinStatusBadge(r.checkin_time, r.checkin_status)}</td>
        <td>${checkoutTimeFormatted ? checkoutTimeFormatted : (r.checkout_status ? '(‡πÄ‡∏ä‡πá‡∏Ñ Manual)' : (r.checkin_time ? '<span style="color: #ff9800;">‚è≥ ‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</span>' : '-'))}</td>
        <td>${getCheckoutStatusBadge(r.checkin_time, r.checkout_status)}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error("loadHistory error:", error);
    document.getElementById("logs").innerHTML = "<tr><td colspan='7'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</td></tr>";
  }
}

function openEditModal() {
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById("editCode").value = studentData.student_code;
  document.getElementById("editName").value = studentData.full_name;
  document.getElementById("editMajor").value = studentData.class_group;
  document.getElementById("editModalStatus").innerHTML = "";
  
  document.getElementById("editModal").style.display = "block";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

async function submitEditRequest() {
  const newCode = document.getElementById("editCode").value;
  const newName = document.getElementById("editName").value;
  const newClass = document.getElementById("editMajor").value;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  if (newCode === studentData.student_code && 
      newName === studentData.full_name && 
      newClass === studentData.class_group) {
    document.getElementById("editModalStatus").innerHTML = 
      '<div class="request-status">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    return;
  }

  try {
    const res = await fetch("../api/student_edit_request.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        line_user_id: lineUserId,
        student_code: newCode,
        full_name: newName,
        class_group: newClass
      })
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status rejected">‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (HTTP ' + res.status + ')</div>';
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from student_edit_request.php");
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status rejected">‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</div>';
      return;
    }

    const data = JSON.parse(text);
    
    if (data.status === "success") {
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status pending">‚úì ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß (Request ID: ' + data.request_id + ')</div>';
      setTimeout(() => {
        closeEditModal();
      }, 2000);
    } else {
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status rejected">‚úó ' + data.message + '</div>';
    }
  } catch (error) {
    console.error("submitEditRequest error:", error);
    document.getElementById("editModalStatus").innerHTML = 
      '<div class="request-status rejected">‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message + '</div>';
  }
}

async function loadRequests(searchId) {
  try {
    const res = await fetch("../api/get_student_requests.php?line_user_id=" + lineUserId + 
      (searchId ? "&search=" + searchId : ""), {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("requestsList").innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>";
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from get_student_requests.php");
      document.getElementById("requestsList").innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>";
      return;
    }

    const requests = JSON.parse(text);
    const list = document.getElementById("requestsList");
    
    if (!Array.isArray(requests) || requests.length === 0) {
      list.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>";
      return;
    }

    let html = "";
    requests.forEach(req => {
      const statusClass = req.status === "pending" ? "pending" : 
                         (req.status === "approved" ? "approved" : "rejected");
      const statusText = req.status === "pending" ? "‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" : 
                        (req.status === "approved" ? "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò");

      html += `
        <div class="request-status ${statusClass}">
          <strong>Request ID: ${req.request_id}</strong><br>
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${req.created_at}<br>
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusText}<br>
          <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤:</strong> ${req.old_student_code} / ${req.old_full_name} / ${req.old_class_group}<br>
          <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà:</strong> ${req.new_student_code} / ${req.new_full_name} / ${req.new_class_group}
        </div>
      `;
    });

    list.innerHTML = html;
  } catch (error) {
    console.error("loadRequests error:", error);
    document.getElementById("requestsList").innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message + "</p>";
  }
}

function searchRequests() {
  const searchId = document.getElementById("searchRequestId").value;
  loadRequests(searchId);
}

window.onclick = function(event) {
  const editModal = document.getElementById("editModal");
  
  if (event.target === editModal) {
    editModal.style.display = "none";
  }
}

init();
</script>

</body>
</html>

