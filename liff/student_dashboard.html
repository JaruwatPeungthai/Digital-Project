<!DOCTYPE html>
<html>
<head>

</style>
</head>
<body>


<meta charset="UTF-8">
<title>Student Dashboard</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Front-end: edit styles in liff/css/student_dashboard.css -->
<link rel="stylesheet" href="css/sidebar.css">
<link rel="stylesheet" href="css/student_dashboard.css">

<style>
.sidebar-header h2 { font-size: 14px; }

.profile-section { background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
.profile-row { margin: 10px 0; }
.profile-row label { font-weight: bold; display: inline-block; min-width: 150px; }
input, select { padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif; }
.advisor-info { background-color: #e8f5e9; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
.close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.close:hover { color: black; }
.request-status { padding: 10px; border-radius: 4px; margin: 10px 0; }
.pending { background-color: #fff3cd; color: #856404; }
.approved { background-color: #d4edda; color: #155724; }
.rejected { background-color: #f8d7da; color: #721c24; }

/* Table styles from session_attendance.css */
.table-wrapper {
  overflow-x: auto;
}

.attendance-table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
}

.attendance-table th {
  background: #f2f2f2;
  border: 1px solid #e6eef6;
  padding: 10px;
  font-weight: 600;
  white-space: nowrap;
}

.attendance-table td {
  border: 1px solid #e6eef6;
  padding: 10px;
  vertical-align: middle;
}

.attendance-table .table-row:hover {
  background: #f9fbfd;
}

.status-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: bold;
}

.badge-late {
  background-color: #ffcdd2;
  color: #c62828;
}

.badge-on-time {
  background-color: #c8e6c9;
  color: #2e7d32;
}

.badge-checked-out {
  background-color: #bbdefb;
  color: #1565c0;
}

.badge-not-checked-out {
  background-color: #ffccbc;
  color: #d84315;
}
</style>
</head>
<body>

<!-- Student Sidebar -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h2 id="sidebarTitle">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
  </div>
  
  <nav class="sidebar-menu">
    <ul class="menu-list">
      <li class="menu-item active">
        <a href="#profile" class="menu-link" onclick="showProfile(event)">
          üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
        </a>
      </li>
      <li class="menu-item">
        <a href="#attendance" class="menu-link" onclick="showAttendance(event)">
          üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </a>
      </li>
      <li class="menu-item">
        <a href="#requests" class="menu-link" onclick="showRequests(event)">
          üìù ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </a>
      </li>
    </ul>
  </nav>
</aside>

<!-- Main Content -->
<div class="main-wrapper">
  <div class="header">
    <h2 id="page-title">üë®‚Äçüéì Dashboard ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
  </div>

  <div class="content-area">
    <div class="container">

      <!-- Profile Section (Default View) -->
      <div id="profileContent" class="card profile-section">
        <h3 class="section-header">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        
  <div class="profile-row">
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</label>
    <span id="codeDisplay" style="font-weight: bold;"></span>
  </div>
  
  <div class="profile-row">
    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
    <span id="nameDisplay" style="font-weight: bold;"></span>
  </div>

  <div class="profile-row">
    <label>‡∏™‡∏≤‡∏Ç‡∏≤:</label>
    <span id="majorDisplay" style="font-weight: bold;"></span>
  </div>

  <div class="profile-row">
    <label>‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:</label>
    <span id="advisorInfo" style="color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</span>
  </div>

        <div class="profile-row" style="margin-top: 20px;">
          <button onclick="openEditModal()" class="btn">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>

        <div id="editStatus"></div>
      </div>

      <!-- Attendance History Section -->
      <div id="attendanceContent" class="card" style="display: none;">
        <h3 class="section-header">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        
        <!-- Combined summary -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:12px; flex-wrap:wrap;">
          <div style="font-weight:600; color:#333;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div style="background:#fff; border:1px solid #e6eef6; padding:8px 12px; border-radius:6px; font-size:14px;">
            <strong>‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏£‡∏ß‡∏°):</strong> <span id="totalCheckins">0</span> &nbsp;|&nbsp;
            <strong>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å:</strong> <span id="totalCheckouts">0</span> &nbsp;|&nbsp;
            <strong>‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</strong> <span id="totalOnTime">0</span> &nbsp;|&nbsp;
            <strong>‡∏™‡∏≤‡∏¢:</strong> <span id="totalLate">0</span> &nbsp;|&nbsp;
            <strong>‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å:</strong> <span id="totalNoCheckout">0</span> &nbsp;|&nbsp;
            <strong>‡∏Ç‡∏≤‡∏î:</strong> <span id="totalAbsent">0</span>
          </div>
        </div>

        <div id="attendanceBySubject"></div>
      </div>

      <!-- Requests Section -->
      <div id="requestsContent" class="card" style="display: none;">
        <h3 class="section-header">üìù ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        
        <div style="margin-bottom: 15px;">
          <input 
            type="text" 
            id="searchRequestId" 
            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Request ID" 
            onkeyup="searchRequests()"
            style="width: 100%; max-width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
          >
        </div>

        <div id="requestsList">
          <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal for editing profile -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
    
    <div class="profile-row">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</label>
      <input type="text" id="editCode">
    </div>
    
    <div class="profile-row">
      <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
      <input type="text" id="editName">
    </div>

    <div class="profile-row">
      <label>‡∏™‡∏≤‡∏Ç‡∏≤:</label>
      <select id="editMajor">
        <option value="‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
        <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô</option>
        <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏û">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏û</option>
        <option value="‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°</option>
        <option value="‡∏ô‡∏¥‡πÄ‡∏ó‡∏®">‡∏ô‡∏¥‡πÄ‡∏ó‡∏®</option>
      </select>
    </div>

    <div id="editModalStatus"></div>

    <div class="profile-row" style="margin-top: 20px;">
      <button onclick="submitEditRequest()" class="btn btn-primary" style="margin-right: 8px;">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button onclick="closeEditModal()" class="btn" style="background: #6c757d;">‚úï ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<script>
const LIFF_ID = "2008718294-WzVz06TP";
let lineUserId = "";
let studentData = {};

// Sidebar menu management
function showProfile(e) {
  if (e) e.preventDefault();
  setActiveMenu(0);
  document.getElementById("profileContent").style.display = "block";
  document.getElementById("attendanceContent").style.display = "none";
  document.getElementById("requestsContent").style.display = "none";
  document.getElementById("page-title").innerText = "üë®‚Äçüéì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô";
}

function showAttendance(e) {
  if (e) e.preventDefault();
  setActiveMenu(1);
  document.getElementById("profileContent").style.display = "none";
  document.getElementById("attendanceContent").style.display = "block";
  document.getElementById("requestsContent").style.display = "none";
  document.getElementById("page-title").innerText = "üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
  loadHistory();
}

function showRequests(e) {
  if (e) e.preventDefault();
  setActiveMenu(2);
  document.getElementById("profileContent").style.display = "none";
  document.getElementById("attendanceContent").style.display = "none";
  document.getElementById("requestsContent").style.display = "block";
  document.getElementById("page-title").innerText = "üìù ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  loadRequests("");
}

function setActiveMenu(index) {
  const items = document.querySelectorAll(".sidebar-menu .menu-item");
  items.forEach((item, i) => {
    item.classList.toggle("active", i === index);
  });
}

async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  lineUserId = profile.userId;

  loadProfile();
}

async function loadProfile() {
  try {
    const res = await fetch("../api/student_profile.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ line_user_id: lineUserId })
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("codeDisplay").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from student_profile.php");
      document.getElementById("codeDisplay").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      return;
    }

    const data = JSON.parse(text);
    
    if (data.error) {
      console.error("API error:", data.error);
      document.getElementById("codeDisplay").innerText = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + data.error;
      return;
    }

    studentData = data;

    document.getElementById("codeDisplay").innerText = data.student_code;
    document.getElementById("nameDisplay").innerText = data.full_name;
    document.getElementById("majorDisplay").innerText = data.class_group;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤
    if (data.advisor_name) {
      document.getElementById("advisorInfo").innerHTML = 
        '<span class="advisor-info">üë®‚Äçüè´ ' + data.advisor_name + '</span>';
    }
    // Set sidebar title to the logged-in student's name
    var st = document.getElementById('sidebarTitle');
    if (st) st.innerText = 'üë®‚Äçüéì ' + (data.full_name || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
  } catch (error) {
    console.error("loadProfile error:", error);
    document.getElementById("codeDisplay").innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
  }
}

async function loadHistory() {
  try {
    const res = await fetch("../api/attendance_history.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ line_user_id: lineUserId })
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("attendanceBySubject").innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>";
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from attendance_history.php");
      document.getElementById("attendanceBySubject").innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>";
      return;
    }

    const rows = JSON.parse(text);
    if (!Array.isArray(rows) || rows.length === 0) {
      document.getElementById("attendanceBySubject").innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>";
      clearSummary();
      return;
    }

    // Group by subject
    const historyBySubject = {};
    const subjectMetadata = {};
    rows.forEach(row => {
      const subj = row.subject_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      if (!historyBySubject[subj]) {
        historyBySubject[subj] = [];
        subjectMetadata[subj] = {
          subject_code: row.subject_code || '',
          teacher_name: row.teacher_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        };
      }
      historyBySubject[subj].push(row);
    });

    // Calculate summaries
    const summaryBySubject = {};
    const totalSummary = { present_checkout: 0, on_time: 0, late: 0, present_no_checkout: 0, absent: 0 };

    Object.keys(historyBySubject).forEach(subj => {
      const summ = { present_checkout: 0, on_time: 0, late: 0, present_no_checkout: 0, absent: 0 };
      historyBySubject[subj].forEach(sess => {
        // Check if either checkin_time or checkin_status exists (manual or auto)
        if (!sess.checkin_time && !sess.checkin_status) {
          summ.absent++;
        } else {
          if (sess.checkout_time || sess.checkout_status) {
            summ.present_checkout++;
          } else {
            summ.present_no_checkout++;
          }
          if (sess.checkin_status === 'late') {
            summ.late++;
          } else {
            summ.on_time++;
          }
        }
      });
      summaryBySubject[subj] = summ;
      Object.keys(summ).forEach(k => { totalSummary[k] += summ[k]; });
    });

    // Update total summary display
    document.getElementById("totalCheckins").innerText = totalSummary.on_time + totalSummary.late;
    document.getElementById("totalCheckouts").innerText = totalSummary.present_checkout;
    document.getElementById("totalOnTime").innerText = totalSummary.on_time;
    document.getElementById("totalLate").innerText = totalSummary.late;
    document.getElementById("totalNoCheckout").innerText = totalSummary.present_no_checkout;
    document.getElementById("totalAbsent").innerText = totalSummary.absent;

    // Render grouped sections
    let html = '';
    let isFirst = true;
    Object.keys(historyBySubject).forEach(subj => {
      const summ = summaryBySubject[subj];
      const meta = subjectMetadata[subj] || {};
      const totalCheckins = summ.on_time + summ.late;

      if (!isFirst) {
        html += '<div style="height: 1px; background: linear-gradient(90deg,#eef6ff,#ffffff); margin:18px 0; border-radius:2px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);"></div>';
      }

      html += '<div style="margin-top:18px; border:1px solid #e6eef6; border-radius:8px; overflow:hidden; background:#fff;">' +
        '<div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background: linear-gradient(90deg,#f7fbff,#f0f8ff);">' +
        '<div>' +
        '<div style="font-weight:700; font-size:15px;">' + htmlEscape(meta.subject_code) + ' ‚Äî ' + htmlEscape(subj) + '</div>' +
        '<div style="color:#666; font-size:13px; margin-top:4px;">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ' + htmlEscape(meta.teacher_name) + '</div>' +
        '</div>' +
        '<div style="text-align:right; background:#fff; border:1px solid #e6eef6; padding:8px 12px; border-radius:6px; font-size:13px; min-width:220px;">' +
        '<div style="font-weight:700; margin-bottom:6px;">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div>' +
        '<div>‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏£‡∏ß‡∏°): <strong>' + totalCheckins + '</strong></div>' +
        '<div>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å: <strong>' + summ.present_checkout + '</strong></div>' +
        '<div>‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤: <strong>' + summ.on_time + '</strong> / ‡∏™‡∏≤‡∏¢: <strong>' + summ.late + '</strong></div>' +
        '<div>‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å: <strong>' + summ.present_no_checkout + '</strong></div>' +
        '<div>‡∏Ç‡∏≤‡∏î: <strong>' + summ.absent + '</strong></div>' +
        '</div>' +
        '</div>' +
        '<div class="table-wrapper" style="padding:12px;">' +
        '<table class="attendance-table">' +
        '<thead>' +
        '<tr class="table-header" style="background: #f2f2f2;">' +
        '<th style="border: 1px solid #e6eef6;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î session</th>' +
        '<th style="border: 1px solid #e6eef6;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà session</th>' +
        '<th style="border: 1px solid #e6eef6;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</th>' +
        '<th style="border: 1px solid #e6eef6;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤</th>' +
        '<th style="border: 1px solid #e6eef6;">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</th>' +
        '<th style="border: 1px solid #e6eef6;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏Å</th>' +
        '</tr>' +
        '</thead>' +
        '<tbody>';

      if (historyBySubject[subj].length > 0) {
        historyBySubject[subj].forEach(r => {
          const sessionDate = formatSessionDate(r.session_date);
          const checkinTime = formatTime(r.checkin_time);
          const checkoutTime = formatTime(r.checkout_time);
          const checkinBadge = getCheckinBadge(r.checkin_time, r.checkin_status);
          const checkoutBadge = getCheckoutBadge(r.checkin_time, r.checkout_time, r.checkout_status);

          html += '<tr class="table-row" style="border-bottom: 1px solid #e6eef6;">' +
            '<td style="border: 1px solid #e6eef6; padding: 10px;">' + htmlEscape(r.room_name || '-') + '</td>' +
            '<td style="border: 1px solid #e6eef6; padding: 10px;">' + sessionDate + '</td>' +
            '<td style="border: 1px solid #e6eef6; padding: 10px;">' + formatCheckinTimeDisplay(checkinTime, r.checkin_status) + '</td>' +
            '<td style="border: 1px solid #e6eef6; padding: 10px;">' + checkinBadge + '</td>' +
            '<td style="border: 1px solid #e6eef6; padding: 10px;">' + formatCheckoutTimeDisplay(checkoutTime, r.checkin_time, r.checkout_status) + '</td>' +
            '<td style="border: 1px solid #e6eef6; padding: 10px;">' + checkoutBadge + '</td>' +
            '</tr>';
        });
      } else {
        html += '<tr><td colspan="6" style="text-align:center; color:#666; padding:20px; border: 1px solid #e6eef6;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ session ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</td></tr>';
      }

      html += '</tbody>' +
        '</table>' +
        '</div>' +
        '</div>';
      isFirst = false;
    });

    document.getElementById("attendanceBySubject").innerHTML = html;
  } catch (error) {
    console.error("loadHistory error:", error);
    document.getElementById("attendanceBySubject").innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message + "</p>";
  }
}

function clearSummary() {
  document.getElementById("totalCheckins").innerText = '0';
  document.getElementById("totalCheckouts").innerText = '0';
  document.getElementById("totalOnTime").innerText = '0';
  document.getElementById("totalLate").innerText = '0';
  document.getElementById("totalNoCheckout").innerText = '0';
  document.getElementById("totalAbsent").innerText = '0';
}

function htmlEscape(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

function formatTime(datetime) {
  if (!datetime) return null;
  const date = new Date(datetime);
  return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
}

function formatSessionDate(datetime) {
  if (!datetime) return '';
  const date = new Date(datetime);
  const dayInThai = { 'Sun': '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', 'Mon': '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', 'Tue': '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', 'Wed': '‡∏û‡∏∏‡∏ò', 'Thu': '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', 'Fri': '‡∏®‡∏∏‡∏Å‡∏£‡πå', 'Sat': '‡πÄ‡∏™‡∏≤‡∏£‡πå' };
  const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Bangkok' };
  const parts = date.toLocaleDateString('th-TH', options).split('/');
  const dayName = new Date(datetime).toLocaleDateString('en-US', { weekday: 'short' });
  const thaiDay = dayInThai[dayName] || dayName;
  return `${parts[0]}/${parts[1]}/${parts[2]} (${thaiDay})`;
}

function getCheckinBadge(checkinTime, checkinStatus) {
  if (!checkinStatus) {
    return '<span class="status-badge badge-not-checked-out">-</span>';
  }
  const badgeClass = checkinStatus === 'late' ? 'badge-late' : 'badge-on-time';
  const statusText = checkinStatus === 'late' ? '‚è±Ô∏è ‡∏™‡∏≤‡∏¢' : '‚úÖ ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
  return '<span class="status-badge ' + badgeClass + '">' + statusText + '</span>';
}

function getCheckoutBadge(checkinTime, checkoutTime, checkoutStatus) {
  if (!checkoutStatus) {
    return '<span class="status-badge badge-not-checked-out">-</span>';
  }
  const badgeClass = checkoutStatus === 'checked-out' ? 'badge-checked-out' : 'badge-not-checked-out';
  const statusText = checkoutStatus === 'checked-out' ? '‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å' : '‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≠‡∏Å';
  return '<span class="status-badge ' + badgeClass + '">' + statusText + '</span>';
}

function formatCheckinTimeDisplay(checkinTime, checkinStatus) {
  if (checkinTime) return checkinTime;
  if (checkinStatus) return '<span style="color: #ff9800; font-size: 12px;">(‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö manual)</span>';
  return '-';
}

function formatCheckoutTimeDisplay(checkoutTime, checkinTime, checkoutStatus) {
  if (checkoutTime) return checkoutTime;
  if (checkoutStatus) return '<span style="color: #ff9800; font-size: 12px;">(‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏ö‡∏ö manual)</span>';
  if (checkinTime) return '<span style="color: #ff9800;">‚è≥ ‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</span>';
  return '-';
}

function openEditModal() {
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById("editCode").value = studentData.student_code;
  document.getElementById("editName").value = studentData.full_name;
  document.getElementById("editMajor").value = studentData.class_group;
  document.getElementById("editModalStatus").innerHTML = "";
  
  document.getElementById("editModal").style.display = "block";
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

async function submitEditRequest() {
  const newCode = document.getElementById("editCode").value;
  const newName = document.getElementById("editName").value;
  const newClass = document.getElementById("editMajor").value;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
  if (newCode === studentData.student_code && 
      newName === studentData.full_name && 
      newClass === studentData.class_group) {
    document.getElementById("editModalStatus").innerHTML = 
      '<div class="request-status">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    return;
  }

  try {
    const res = await fetch("../api/student_edit_request.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        line_user_id: lineUserId,
        student_code: newCode,
        full_name: newName,
        class_group: newClass
      })
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status rejected">‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (HTTP ' + res.status + ')</div>';
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from student_edit_request.php");
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status rejected">‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</div>';
      return;
    }

    const data = JSON.parse(text);
    
    if (data.status === "success") {
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status pending">‚úì ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß (Request ID: ' + data.request_id + ')</div>';
      setTimeout(() => {
        closeEditModal();
      }, 2000);
    } else {
      document.getElementById("editModalStatus").innerHTML = 
        '<div class="request-status rejected">‚úó ' + data.message + '</div>';
    }
  } catch (error) {
    console.error("submitEditRequest error:", error);
    document.getElementById("editModalStatus").innerHTML = 
      '<div class="request-status rejected">‚úó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message + '</div>';
  }
}

async function loadRequests(searchId) {
  try {
    const res = await fetch("../api/get_student_requests.php?line_user_id=" + lineUserId + 
      (searchId ? "&search=" + searchId : ""), {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) {
      console.error("HTTP error:", res.status);
      document.getElementById("requestsList").innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>";
      return;
    }

    const text = await res.text();
    if (!text) {
      console.error("Empty response from get_student_requests.php");
      document.getElementById("requestsList").innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>";
      return;
    }

    const requests = JSON.parse(text);
    const list = document.getElementById("requestsList");
    
    if (!Array.isArray(requests) || requests.length === 0) {
      list.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>";
      return;
    }

    let html = "";
    requests.forEach(req => {
      const statusClass = req.status === "pending" ? "pending" : 
                         (req.status === "approved" ? "approved" : "rejected");
      const statusText = req.status === "pending" ? "‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" : 
                        (req.status === "approved" ? "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò");

      html += `
        <div class="request-status ${statusClass}">
          <strong>Request ID: ${req.request_id}</strong><br>
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${req.created_at}<br>
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusText}<br>
          <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤:</strong> ${req.old_student_code} / ${req.old_full_name} / ${req.old_class_group}<br>
          <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà:</strong> ${req.new_student_code} / ${req.new_full_name} / ${req.new_class_group}
        </div>
      `;
    });

    list.innerHTML = html;
  } catch (error) {
    console.error("loadRequests error:", error);
    document.getElementById("requestsList").innerHTML = "<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message + "</p>";
  }
}

function searchRequests() {
  const searchId = document.getElementById("searchRequestId").value;
  loadRequests(searchId);
}

window.onclick = function(event) {
  const editModal = document.getElementById("editModal");
  
  if (event.target === editModal) {
    editModal.style.display = "none";
  }
}

init();
</script>

</body>
</html>

